name: Release

on:
  pull_request:
    branches: [master]
    types: closed

jobs:
  release_tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          ref: master
          # Needed for git log history
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh

      - name: Create & tag release
        run: |
          git fetch --tags
          gh config set prompt disabled
          VERSION=$(git tag --sort=-committerdate | head -n1 | cut -c 2-)
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          LABELS=$(echo "${{ toJson(github.event.pull_request.labels.*.name) }}")
          { if [[ "$LABELS" == *"major"* ]]; then
              MAJOR=$((MAJOR+1))
            elif [[ "$LABELS" == *"minor"* ]]; then
              MINOR=$((MINOR+1))
            elif [[ "$LABELS" == *"patch"* ]]; then
              PATCH=$((PATCH+1))
            else
              echo "No release labels found."
            fi
            if [[ "$VERSION" == "" ]]; then
              MAJOR=1
              MINOR=0
              PATCH=0
            fi
          }
          gh release create "v$MAJOR.$MINOR.$PATCH" \
            -t "$MAJOR.$MINOR.$PATCH" \
            -n "<h1>Release for version $MAJOR.$MINOR.$PATCH</h1><h2>Commits since last release</h2><b>$(git log origin/master..origin/develop --no-merges --reverse --format=format:%h\ %s\<br\>\<br\>)</b>" \
            --target master
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
